# Implementation Plan - Telegram Bot Version 0.0.2

## Overview

Этот план содержит пошаговые задачи для реализации версии 0.0.2 бота. Каждая задача построена инкрементально и включает конкретные файлы для создания или модификации.

---

## Tasks

- [x] 1. Настройка проекта и зависимостей



  - Создать новую структуру директорий для модульной архитектуры
  - Обновить requirements.txt с новыми зависимостями (supabase, python-dotenv)
  - Создать config.py для управления переменными окружения
  - Создать .env.example с шаблоном переменных окружения
  - _Requirements: 4.1, 4.2_


- [x] 2. Реализация Database Layer


- [x] 2.1 Создать модели данных

  - Создать database/models.py с классами User и TaskResponse
  - Реализовать методы to_dict() для конвертации в словари
  - Добавить валидацию полей в моделях
  - _Requirements: 2.1, 4.3_



- [x] 2.2 Реализовать Supabase клиент

  - Создать database/supabase_client.py с классом SupabaseClient
  - Реализовать методы: get_user(), create_user(), update_user()
  - Реализовать методы: get_user_responses(), create_response(), check_response_exists()
  - Добавить обработку ошибок подключения к Supabase


  - _Requirements: 4.1, 4.4, 4.5, 4.6, 4.7, 7.1, 7.3_

- [x] 2.3 Создать SQL схему для Supabase

  - Создать database/schema.sql с определениями таблиц users и responses
  - Добавить индексы для оптимизации запросов
  - Добавить foreign key constraints
  - Документировать процесс создания таблиц в Supabase Dashboard
  - _Requirements: 4.2, 4.3_

- [x] 3. Реализация Service Layer

- [ ] 3.1 Создать UserService
  - Создать services/user_service.py с классом UserService
  - Реализовать register_user() для регистрации новых пользователей
  - Реализовать get_user_profile() для получения профиля
  - Реализовать is_user_registered() для проверки регистрации
  - Реализовать update_balance() для обновления баланса
  - Реализовать increment_completed_tasks() для увеличения счетчика
  - _Requirements: 1.3, 1.4, 2.1, 2.2, 5.1, 5.2, 6.1_

- [x] 3.2 Создать TaskService

  - Создать services/task_service.py с классом TaskService
  - Реализовать get_all_tasks() для получения списка заданий (из памяти)
  - Реализовать get_task_by_id() для получения задания по ID
  - Реализовать create_response() для создания отклика с обновлением баланса
  - Реализовать get_user_responses() для получения истории откликов
  - Реализовать has_user_responded() для проверки дубликатов
  - _Requirements: 5.1, 5.2, 5.3, 5.4, 10.4, 10.5_


- [ ] 3.3 Обновить AIService
  - Скопировать generate_response() из версии 0.0.1 в services/ai_service.py
  - Обернуть в класс AIService для будущего расширения
  - Сохранить существующую логику генерации по шаблонам
  - _Requirements: 9.1, 9.2_

- [x] 4. Реализация Keyboard Layer

- [x] 4.1 Создать inline клавиатуры

  - Создать keyboards/inline_keyboards.py
  - Реализовать get_main_menu_keyboard() с кнопками главного меню
  - Реализовать get_registration_keyboard() для регистрации
  - Реализовать get_tasks_keyboard() для списка заданий
  - Реализовать get_task_details_keyboard() для деталей задания
  - Реализовать get_back_button() для возврата в главное меню
  - _Requirements: 3.1, 3.2, 3.3, 10.1, 10.2_

- [ ] 5. Реализация Handler Layer
- [x] 5.1 Создать start handler с регистрацией

  - Создать handlers/start_handler.py
  - Реализовать cmd_start() с проверкой регистрации пользователя
  - Если пользователь не зарегистрирован - показать кнопку регистрации
  - Если зарегистрирован - показать главное меню
  - Реализовать callback handler для кнопки регистрации
  - _Requirements: 1.1, 1.2, 1.3, 1.5, 6.1, 6.2, 6.4, 9.1_


- [ ] 5.2 Создать profile handler
  - Создать handlers/profile_handler.py
  - Реализовать cmd_profile() для команды /profile
  - Форматировать профиль с emoji и структурой
  - Добавить inline кнопки для действий с профилем
  - Добавить проверку регистрации пользователя
  - _Requirements: 2.2, 2.3, 2.4, 6.1, 6.2_


- [ ] 5.3 Создать tasks handler
  - Создать handlers/tasks_handler.py
  - Реализовать cmd_tasks() для команды /tasks
  - Отображать список заданий с inline кнопками
  - Добавить проверку регистрации пользователя
  - Сохранить обратную совместимость с /respond <task_id>
  - _Requirements: 9.1, 9.2, 9.3, 10.1, 10.2_

- [x] 5.4 Создать balance handler

  - Создать handlers/balance_handler.py
  - Реализовать cmd_balance() для команды /balance
  - Отображать баланс и статистику с форматированием
  - Добавить проверку регистрации пользователя
  - _Requirements: 6.1, 6.2, 9.1_


- [ ] 5.5 Создать callback handler для inline кнопок
  - Создать handlers/callback_handler.py
  - Реализовать handle_main_menu() для обработки кнопок главного меню
  - Реализовать handle_tasks_list() для кнопки "Список заданий"
  - Реализовать handle_task_details() для кнопки "Подробнее"
  - Реализовать handle_task_respond() для кнопки "Откликнуться"
  - Реализовать handle_balance() для кнопки "Баланс"
  - Реализовать handle_profile() для кнопки "Профиль"
  - Реализовать handle_my_responses() для кнопки "Мои отклики"
  - Реализовать handle_settings() для кнопки "Настройки" (заглушка)
  - Добавить обработку ошибок для каждого callback
  - _Requirements: 3.3, 3.4, 3.5, 3.6, 3.7, 3.8, 10.3, 10.4, 10.5, 10.6_


- [ ] 6. Реализация обработки ошибок
- [ ] 6.1 Создать error handler
  - Создать utils/error_handler.py
  - Реализовать глобальный error handler для бота
  - Добавить логирование ошибок с контекстом
  - Реализовать декоратор require_registration для проверки регистрации
  - Добавить обработку специфичных ошибок (БД, валидация, дубликаты)
  - _Requirements: 6.2, 6.3, 7.1, 7.2, 7.3, 7.4, 7.5_


- [ ] 7. Обновление главного файла бота
- [ ] 7.1 Рефакторинг bot.py
  - Обновить bot.py для использования новой модульной структуры
  - Инициализировать Supabase клиент из config
  - Инициализировать все сервисы (UserService, TaskService, AIService)
  - Зарегистрировать все handlers (start, profile, tasks, balance, callback)
  - Зарегистрировать глобальный error handler
  - Добавить логирование запуска бота
  - _Requirements: 4.1, 7.5, 9.1_


- [ ] 8. Создание миграционного скрипта
- [x] 8.1 Реализовать миграцию из JSON в Supabase

  - Создать migrations/migrate_from_json.py
  - Реализовать чтение данных из user_data.json
  - Реализовать миграцию пользователей в таблицу users
  - Реализовать миграцию откликов в таблицу responses
  - Добавить обработку ошибок и rollback при неудаче
  - Вывести статистику миграции (количество пользователей, откликов)
  - _Requirements: 8.1, 8.2, 8.3, 8.4, 8.5_

- [x] 9. Документация и настройка

- [ ] 9.1 Обновить документацию
  - Обновить README.md с инструкциями по настройке Supabase
  - Создать SUPABASE_SETUP.md с пошаговой настройкой Supabase
  - Обновить QUICKSTART.md с новыми шагами установки
  - Добавить примеры использования inline кнопок в EXAMPLES.md
  - Документировать процесс миграции из v0.0.1


- [ ] 9.2 Создать конфигурационные файлы
  - Создать .env.example с шаблоном переменных
  - Обновить .gitignore для исключения .env и database credentials
  - Создать docker-compose.yml для локальной разработки (опционально)

- [ ] 10. Тестирование и валидация
- [ ]* 10.1 Протестировать регистрацию
  - Проверить регистрацию нового пользователя через /start
  - Проверить повторный /start для зарегистрированного пользователя
  - Проверить сохранение данных в Supabase
  - Проверить обработку ошибок при проблемах с БД

- [ ]* 10.2 Протестировать inline кнопки
  - Проверить все кнопки главного меню
  - Проверить навигацию по заданиям
  - Проверить кнопку "Откликнуться"
  - Проверить кнопку "Назад"
  - Проверить обработку callback errors

- [ ]* 10.3 Протестировать отклики на задания
  - Проверить создание отклика через inline кнопку
  - Проверить обновление баланса в БД
  - Проверить инкремент completed_tasks
  - Проверить защиту от дубликатов
  - Проверить обратную совместимость с /respond <task_id>

- [ ]* 10.4 Протестировать профиль и баланс
  - Проверить отображение профиля через /profile
  - Проверить отображение баланса через /balance
  - Проверить актуальность данных из БД
  - Проверить inline кнопки в профиле

- [ ]* 10.5 Протестировать миграцию
  - Создать тестовый user_data.json с данными
  - Запустить миграционный скрипт
  - Проверить корректность данных в Supabase
  - Проверить работу бота с мигрированными данными

- [ ] 11. Финальная интеграция и деплой
- [x] 11.1 Финальное тестирование

  - Выполнить полный цикл: регистрация → задания → отклик → баланс → профиль
  - Проверить все edge cases (ошибки БД, невалидные данные, дубликаты)
  - Проверить производительность (время отклика < 1 сек)
  - Проверить логирование ошибок


- [ ] 11.2 Подготовка к деплою
  - Обновить DEPLOYMENT.md с инструкциями для Supabase
  - Создать checklist для production deployment
  - Добавить мониторинг и алерты (опционально)
  - Создать backup стратегию для БД
